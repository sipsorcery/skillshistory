<html>

<head>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <!-- jQuery library -->
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">-->

    <script src="skillshistorydata.js"></script>

    <script>

        $(document).ready(function () {
            //displaySkills(skillsHistory);
            skillsHistory.forEach(x => x.childcount = skillsHistory.filter(y => x.id !== undefined && x.id === y.parentid).length);
            displaySkills(skillsHistory.filter(x => x.parentid === undefined));
        });

        function displaySkills(skillsArr) {

            $('#skillsTable').html("<thead><tr/></thead><tbody></tbody>");

            // Get common info needed for display (e.g. list of skills, start and end quarters).
            let skillNames = getSkills(skillsArr);
            let min = skillsArr.flatMap(x => x.history.map(y => y.period)).filter(z => z !== undefined).sort()[0];
            let max = skillsArr.flatMap(x => x.history.map(y => y.period)).filter(z => z !== undefined).sort().slice(-1)[0];

            // Local expression to return the number of child skills for a parent.
            let getChildCount = (name) => skillsArr.find(y => y.name == name).childcount;

            // Build the table.
            addSkillNameCols(skillNames, getChildCount);
            addRowsToTable(min, max, skillNames, skillsArr);
        }

        function displayChildSkills(skillNameOrId) {
            $('#errormsg').text();
            $('#errorMsgDiv').hide()

            if (skillNameOrId === '') {
                // Display top level skills.
                displaySkills(skillsHistory.filter(x => x.parentid === undefined));
            }
            else {
                let parentSkill = skillsHistory.find(x => x.name == skillNameOrId);
                if (parentSkill === undefined) {
                    // Couldn't match a parent skill name. Try using the id.
                    parentSkill = skillsHistory.find(x => x.id == skillNameOrId);
                }

                if (parentSkill === undefined) {
                    $('#errormsg').text("Sorry something has gone wrong. The requested skill or skill ID could not be found.");
                    $('#errorMsgDiv').show();
                }
                else {
                    let childSkills = skillsHistory.filter(y => y.parentid !== undefined && y.parentid === parentSkill.id);
                    console.log(childSkills);
                    displaySkills(childSkills);
                }
            }
        }

        function getSkills(skillsArr) {
            let names = skillsArr.map(x => x.name);
            return names;
        }

        function addSkillNameCols(skillNamesArr, getChildCount) {
            let headerRow = $('#skillsTable thead > tr');
            headerRow.append(`<th class="datecol">Quarter</th>`);

            skillNamesArr.forEach(skill => {
                let childCount = getChildCount(skill);
                if (getChildCount(skill) > 0) {
                    headerRow.append(`<th class="rotate"><a href="javascript:displayChildSkills('${skill}')" class="badge badge-light">${skill} <span class="badge">(+${childCount})</span></a></th>`);
                }
                else {
                    headerRow.append(`<th class="rotate"><label class="badge badge-light">${skill}</label></th>`);
                }
            });
        }

        function addRowsToTable(min, max, skillNames, skillsHistoryArr) {
            let rowPosn = $('#skillsTable tbody');
            for (i = max; i >= min; i--) {
                if (i % 10 == 0) {
                    i = i - i % 10 - 6;
                }

                let rowContents = `<tr><td>${i / 10 >> 0} Q${i % 10}</td>`;
                skillNames.forEach(x => {
                    let skillRow = skillsHistoryArr.find(y => y.name == x);
                    let skillUsageEntry = skillRow.history.find(z => z.period == i);

                    if (skillUsageEntry !== undefined) {
                        rowContents += `<td class="${skillUsageEntry.usage}" style="background-color: ${skillRow.colour}"/>`;
                    }
                    else {
                        rowContents += '<td/>';
                    }
                });
                rowContents += "</tr>";
                rowPosn = rowPosn.append(rowContents);
            }
        }

    </script>

    <style>
        table#skillsTable {
            border-collapse: unset;
            border-spacing: 0px;
            padding-top: 100px;
            padding-bottom: 50px;
        }

        table#skillsTable th.datecol {
            min-width: 100px;
            max-width: 100px;
        }

        table#skillsTable th {
            min-width: 50px;
            max-width: 50px;
        }

        table#skillsTable th.rotate {
            transform:
                rotate(300deg) translateX(20px);
            text-align: left;
        }

        table#skillsTable td {
            min-width: 50px;
            max-width: 50px;
            height: 25px;
        }

        td.primary {
            background-image: url("primary.png");
            background-size: 100%;
        }

        td.regular {
            background-image: url("regular.png");
            background-size: 100%;
        }

        td.occasional {
            background-image: url("occasional.png");
            background-size: 100%;
        }
    </style>

</head>

<body>
    <div class="container-lg">
        <div class="row">
            <div class="col-md-12">
                <p>Skills Usage Table v0.1</p>
                <span>Common Skill Filters:</span>
                <p>
                    <a href="javascript:displayChildSkills('')" class="badge badge-primary">.</a>
                    <a href="javascript:displayChildSkills('.net')" class="badge badge-primary">.NET</a>
                    <a href="javascript:displayChildSkills('error')" class="badge badge-primary">error</a>
                </p>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="alert alert-warning alert-dismissible" id="errorMsgDiv" style="display: none">
                    <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                    <span id="errormsg"></span>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">

                <table id="skillsTable">
                    <thead>
                        <tr />
                    </thead>
                    <tbody></tbody>
                </table>

            </div>
        </div>
    </div>
</body>

</html>

<!-- Latest compiled JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>